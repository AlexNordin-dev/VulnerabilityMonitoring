@* ~/Views/Shared/Partials/Dashboard/_dashboardData.cshtml *@
@model List<VulnerableProjectViewModels>
@using System.Text.RegularExpressions

@{
    Layout = "";
}




@{
    // Variabler för att räkna antalet sårbara paket per severity
    int highSeverityCount = 0;
    int moderateSeverityCount = 0;
    int criticalSeverityCount = 0;
    int lowSeverityCount = 0;


    // Loopa igenom varje projekt för att räkna antalet sårbara paket per severity
    foreach (var project in Model)
    {
        foreach (var package in project.VulnerableProjectPackage)
        {
            switch (package.Severity)
            {
                case "High":
                    highSeverityCount++;
                    break;
                case "Moderate":
                    moderateSeverityCount++;
                    break;
                case "Critical":
                    criticalSeverityCount++;
                    break;
                case "Low":
                    lowSeverityCount++;
                    break;
                default:
                    break;
            }
        }
    }
    var totalVulnerablepackage = highSeverityCount + moderateSeverityCount + criticalSeverityCount + lowSeverityCount;
}



<div class="content">
    <div class="container">

        <div>
            <div class="row">
                <div class="col-md-12 page-header">
                    <div class="page-pretitle">Overview</div>
                    <h1 class="page-title">Dashboard</h1>

                </div>
            </div>
            <hr />
            <div class="row">

                <div class="col-md-12 col-sm-12 col-lg-12 mt-3 mb-3">
                    <div class="row ">
                        <div class="col-md-6 mt-4 ">
                            <div class="card h-100">
                                <div class="content">
                                    <div class="head">
                                        <h5 class="mb-0"> <i class=" fas fa-cube"></i> Projects: </h5>
                                        <p class="text-muted">
                                            Total Projects: <span class="text-primary">@Model.Count()</span> <br />
                                            Total Vulnerable projects: <span class="text-danger">@Model.Count(x => x.VulnerableProjectPackage.Any())</span>
                                        </p>
                                    </div>
                                    @*  <div class="canvas-wrapper">
                                    <hr />

                                    </div> *@
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mt-4">
                            <div class="card h-100">
                                <div class="content">
                                    <div class="head">
                                        <h5 class="mb-0"> <i class=" fas fa-box"></i> Packages:</h5>
                                        <p class="text-muted">  Total Vulnerable packages:<span class="text-danger"> @totalVulnerablepackage</span>  </p>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- High severity level -->
                <div class="col-sm-6 col-md-6 col-lg-3 mt-3">
                    <div class="card highSeverity">
                        <div class="content">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="icon-big text-center">
                                        <i class=" fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="detail " >
                                        <p class="detail-subtitle">High Packages</p>
                                        <span class="number">@highSeverityCount</span>
                                    </div>
                                </div>
                            </div>
                            <div class="footer">
                                <hr />
                                <div class="stats">
                                    <i class="fas fa-info-circle"></i>  High severity level
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--  Moderate severity level -->
                <div class="col-sm-6 col-md-6 col-lg-3 mt-3">
                    <div class="card moderateSeverity">
                        <div class="content">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="icon-big text-center">
                                        <i class="orange fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="detail">
                                        <p class="detail-subtitle">Moderate Packages</p>
                                        <span class="number"> @moderateSeverityCount</span>
                                    </div>
                                </div>
                            </div>
                            <div class="footer">
                                <hr />
                                <div class="stats">
                                    <i class="fas fa-info-circle"></i>  Moderate severity level
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Very high level of severity -->
                <div class="col-sm-6 col-md-6 col-lg-3 mt-3">
                    <div class="card criticalSeverity">
                        <div class="content">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="icon-big text-center">
                                        <i class="violet fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="detail">
                                        <p class="detail-subtitle">Critical Packages</p>
                                        <span class="number">@criticalSeverityCount</span>
                                    </div>
                                </div>
                            </div>
                            <div class="footer">
                                <hr />
                                <div class="stats">
                                    <i class="fas fa-info-circle"></i>  Very high level of severity
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--  Low severity level -->
                <div class="col-sm-6 col-md-6 col-lg-3 mt-3">
                    <div class="card lowSeverity">
                        <div class="content">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="icon-big text-center">
                                        <i class="teal fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="detail">
                                        <p class="detail-subtitle">Low Packages</p>
                                        <span class="number">@lowSeverityCount</span>
                                    </div>
                                </div>
                            </div>
                            <div class="footer">
                                <hr />
                                <div class="stats">
                                    <i class="fas fa-info-circle"></i>  Low severity level
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Sökformulär -->
        <div class="row">
            <div class="col-12">
                <input type="text" id="searchInput" placeholder="Sök efter projekt..." class="form-control mb-3">
            </div>
        </div>
        <!--  Scan Results -->
        <div class="row mb-5" id="projectsContainer">
            @if (Model == null || !Model.Any())
            {
                <h2 class="fs-4">Inga projekt matchar din sökning. Vänligen gå till Add-Project-sidan och lägg till ett projekt att skanna.</h2>
            }
            else
            {
                <h2 class="fs-4">Vulnerability Scan Results:</h2>
                @foreach (var project in Model)
                {
                    <div class="col-md-12 col-lg-12 project-card" data-project-name="@project.ProjectSloName.ToLower()">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <span><i class="fas fa-cube"></i> Project: @project.ProjectSloName</span> <br />
                                    <span><i class="fas fa-clock"></i> Last run time: @project.LastRunTime</span>
                                </div>
                                <div>
                                    <form method="post" action="@Url.Action("RunVulnerabilityScan", "Home")">
                                        <input type="hidden" name="ProjectsSlnPath" value="@project.ProjectsSlnPath" />
                                        <input type="hidden" name="ProjectsFramework" value="@project.ProjectsFramework" />
                                        <input type="hidden" name="RepositoryId" value="@project.RepositoryId" />
                                        <button type="submit" class="btn btn-primary">Run Scan</button>
                                    </form>
                                </div>
                            </div>

                            <div class="card-body">
                                @if (project.VulnerableProjectPackage.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table" id="dataTableHome">
                                            <thead>
                                                <tr>
                                                    <th>Project Name</th>
                                                    <th>Package Name</th>
                                                    <th>Requested Version</th>
                                                    <th>Resolved Version</th>
                                                    <th>Severity</th>
                                                    <th>Advisory URL</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var package in project.VulnerableProjectPackage)
                                                {
                                                    if (!string.IsNullOrEmpty(package.ProjectName))
                                                    {
                                                        <tr >
                                                            <td colspan="6" class="border-bottom-0 text-info m-1 pt-5 pb-0">@package.ProjectName</td> <!-- Endast visa denna rad om ProjectName inte är tom -->
                                                        </tr>
                                                    }
                                                    <tr class="">
                                                        <!-- Fortsätt med de övriga kolumnerna som vanligt om nödvändigt -->
                                                        <td class="">@package.PackageName</td>
                                                        <td class="">@package.RequestedVersion</td>
                                                        <td class="">@package.ResolvedVersion</td>
                                                        <td class="">
                                                            @switch (package.Severity)
                                                            {
                                                                case "High":
                                                                    <span class="highSeverity">@package.Severity</span>
                                                                    break;
                                                                case "Moderate":
                                                                    <span class="moderateSeverity">@package.Severity</span>
                                                                    break;
                                                                case "Critical":
                                                                    <span class="criticalSeverity">@package.Severity</span>
                                                                    break;
                                                                case "Low":
                                                                    <span class="lowSeverity">@package.Severity</span>
                                                                    break;
                                                                default:
                                                                    @package.Severity
                                                                    break;
                                                            }
                                                        </td>
                                                        <td class="">
                                                            <a href="@package.AdvisoryURL" target="_blank">@package.AdvisoryURL</a>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                @if (project.LastRunTime == DateTime.MinValue)
                                {
                                    <p>Run scan manually.</p>
                                }
                                @if (project.VulnerableProjectPackage.Count == 0 && project.LastRunTime != DateTime.MinValue)
                                {
                                    <p>No vulnerabilities found.</p>
                                }
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
